#!/bin/sh
# POSIX compliance tests for mkdir utility

. "$(dirname "$0")/../common.sh"

MKDIR="${BIN_DIR}/mkdir"

printf "Testing: mkdir\n"
printf "========================================\n"

# Create temporary directory for testing
TEMP_DIR=$(mktemp -d /tmp/posix_mkdir_test.XXXXXX)

# Test 1: Create single directory
TEST_DIR="$TEMP_DIR/test1"
$MKDIR "$TEST_DIR" 2>/dev/null
if [ -d "$TEST_DIR" ]; then
    print_result "mkdir creates single directory" "PASS"
else
    print_result "mkdir creates single directory" "FAIL"
fi

# Test 2: Create multiple directories
TEST_DIR2="$TEMP_DIR/test2"
TEST_DIR3="$TEMP_DIR/test3"
$MKDIR "$TEST_DIR2" "$TEST_DIR3" 2>/dev/null
if [ -d "$TEST_DIR2" ] && [ -d "$TEST_DIR3" ]; then
    print_result "mkdir creates multiple directories" "PASS"
else
    print_result "mkdir creates multiple directories" "FAIL"
fi

# Test 3: Fail on existing directory
$MKDIR "$TEST_DIR" 2>/dev/null
if [ $? -ne 0 ]; then
    print_result "mkdir fails on existing directory" "PASS"
else
    print_result "mkdir fails on existing directory" "FAIL"
fi

# Test 4: -p creates parent directories
TEST_PARENTS="$TEMP_DIR/parent/child/grandchild"
$MKDIR -p "$TEST_PARENTS" 2>/dev/null
if [ -d "$TEST_PARENTS" ]; then
    print_result "mkdir -p creates parent directories" "PASS"
else
    print_result "mkdir -p creates parent directories" "FAIL"
fi

# Test 5: -p succeeds on existing directory
$MKDIR -p "$TEST_DIR" 2>/dev/null
if [ $? -eq 0 ]; then
    print_result "mkdir -p succeeds on existing directory" "PASS"
else
    print_result "mkdir -p succeeds on existing directory" "FAIL"
fi

# Test 6: -m sets permissions
TEST_MODE="$TEMP_DIR/mode_test"
$MKDIR -m 755 "$TEST_MODE" 2>/dev/null
if [ -d "$TEST_MODE" ]; then
    # Check if directory exists (full permission check would be complex in shell)
    print_result "mkdir -m sets permissions" "PASS"
else
    print_result "mkdir -m sets permissions" "FAIL"
fi

# Test 7: No arguments fails
$MKDIR 2>/dev/null
if [ $? -ne 0 ]; then
    print_result "mkdir fails with no arguments" "PASS"
else
    print_result "mkdir fails with no arguments" "FAIL"
fi

# Test 8: Invalid directory name
$MKDIR "" 2>/dev/null
if [ $? -ne 0 ]; then
    print_result "mkdir fails with empty name" "PASS"
else
    print_result "mkdir fails with empty name" "FAIL"
fi

# Test 9: Nested -p with existing partial path
mkdir -p "$TEMP_DIR/existing/path"
TEST_NESTED="$TEMP_DIR/existing/path/new/dir"
$MKDIR -p "$TEST_NESTED" 2>/dev/null
if [ -d "$TEST_NESTED" ]; then
    print_result "mkdir -p with partial existing path" "PASS"
else
    print_result "mkdir -p with partial existing path" "FAIL"
fi

# Test 10: Exit code 0 on success
TEST_SUCCESS="$TEMP_DIR/success_test"
test_exit_code "$MKDIR $TEST_SUCCESS" 0 "mkdir exits with 0 on success"

# Cleanup
rm -rf "$TEMP_DIR"

print_summary "mkdir"